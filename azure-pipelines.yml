trigger:
  branches:
    include:
      - main  

pool:
  vmImage: 'ubuntu-latest' 


stages:
  - stage: Deploy
    jobs:
      - job: DeployHelm
        displayName: "Deploy Helm Chart to AKS"
        steps:
        
       
        - task: Kubernetes@1
          name: 'KubeLogin'
          displayName: "Login to AKS"
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceEndpoint: 'kuber-connection'

        
        - task: HelmDeploy@0
          displayName: "Deploy Helm Chart"
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceEndpoint: 'kuber-connection'
            namespace: 'default'  
            command: 'upgrade'  
            chartType: 'FilePath'
            chartPath: 'helm-service' 
            releaseName: 'release' 
            install: true  

        
        - script: |
            helm status release
          displayName: "Check Helm Release Status"

        
        - script: |
            if [[ $(helm status elease | grep 'STATUS' | awk '{print $2}') != "deployed" ]]; then
              echo "Helm deployment failed, rolling back..."
              helm rollback release  
            else
              echo "Deployment successful!"
            fi
          displayName: "Rollback on Failure"